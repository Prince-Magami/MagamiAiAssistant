<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PMAI - Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="dark-theme">
    <div class="chat-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo-glow">ðŸ¤– PMAI</div>
            <nav>
                <ul>
                    <li><a href="/chat" class="active">Chat</a></li>
                    <li><a href="/profile">Profile</a></li>
                    {% if user.email == 'magamiabu@gmail.com' %}
                    <li><a href="/admin">Analytics</a></li>
                    {% endif %}
                    <li><a href="/logout">Logout</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-main">
            <div class="chat-header">
                <h1>Talk to PMAI</h1>
                <div class="controls">
                    <select id="modeSelect">
                        <option>Chatbox</option>
                        <option>Scam/Email Checker</option>
                        <option>Exam/Academic Assistant</option>
                        <option>Business Helper</option>
                        <option>Cybersecurity Advisor</option>
                    </select>

                    <select id="langSelect">
                        <option value="English" selected>English</option>
                        <option value="Pidgin">Pidgin</option>
                    </select>
                </div>
            </div>

            <div id="chatDisplay" class="chat-display">
                <!-- Chat history dynamically inserted here -->
                {% for message in messages %}
                <div class="chat-bubble user"><strong>You:</strong> {{ message.prompt }}</div>
                <div class="chat-bubble ai"><strong>PMAI:</strong> {{ message.response }}</div>
                {% endfor %}
            </div>

            <form id="chatForm" class="chat-form">
                <textarea id="chatInput" placeholder="Type your message..." rows="2" required></textarea>
                <button type="submit">âž¤</button>
            </form>
        </main>
    </div>

    <script>
        const form = document.getElementById('chatForm');
        const input = document.getElementById('chatInput');
        const display = document.getElementById('chatDisplay');
        const mode = document.getElementById('modeSelect');
        const lang = document.getElementById('langSelect');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = input.value.trim();
            if (!userInput) return;

            const userBubble = document.createElement('div');
            userBubble.className = 'chat-bubble user';
            userBubble.innerHTML = `<strong>You:</strong> ${userInput}`;
            display.appendChild(userBubble);

            input.value = '';
            input.focus();
            display.scrollTop = display.scrollHeight;

            try {
                const res = await axios.post('/send', {
                    message: userInput,
                    mode: mode.value,
                    lang: lang.value
                });

                const aiBubble = document.createElement('div');
                aiBubble.className = 'chat-bubble ai';
                aiBubble.innerHTML = `<strong>PMAI:</strong> ${res.data.reply}`;
                display.appendChild(aiBubble);

                display.scrollTop = display.scrollHeight;
            } catch (err) {
                const errorBubble = document.createElement('div');
                errorBubble.className = 'chat-bubble error';
                errorBubble.innerHTML = `<strong>Error:</strong> Something went wrong.`;
                display.appendChild(errorBubble);
            }
        });

        input.addEventListener("keydown", function(e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                form.dispatchEvent(new Event("submit"));
            }
        });
    </script>
</body>
</html>
